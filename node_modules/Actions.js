module.exports = function(_screen) {

    var vk = require('VK');
    vk.checkToken();

    var message_id = 0; // переменная для хранения ID беседы
    var str_message_obj = ''; //  строковое представление возвращаемого объекта беседы
    var str_friend_obj = ''; // строковое представление возвращаемого объекта списка диалогов


    // отобразить список друзей
    this.friends = function() {

        console.log(_screen);

        // vk.request('friends.get', {
        //     fields: 'uid,first_name,last_name',
        //     count: 2,
        //     order: 'hints'
        // }, function(data) {
        //     //
        //     console.log( data );
        // });

    };

    this.getDialogs = function() {
        vk.request('messages.getDialogs', {
            preview_length: 10,
            v: 5.24
        }, function(data) {
debugger;
            if (data && data.response) {


                var mess = data.response.items;
                var str = '';


                for (var j = 0; j < mess.length; j++) {
                    mess[j].message['name'] = _friend(mess[j].message.user_id);
                }

                // если сообщения не изменились, то завершаем выполнение
                if (str_friend_obj === JSON.stringify(mess))
                    return false;

                _screen.FriendList.setItems([]);

                // если сообщения изменились то выводим их на экран
                str_friend_obj = JSON.stringify(mess);

                for (var i = 0; i < mess.length; i++) {

                    str = mess[i].message.body;

                    str = '{bold}' + mess[i].message.name + ':{/bold} ' + str +
                        '                __|' + mess[i].message.user_id + '|__';

                    if (mess[i].message.read_state === 0) {
                        str = '{red-fg}' + str + '{/red-fg}';
                    }

                    _screen.FriendList.add(str);
                }

                // уведомление о новом сообщении
                notice();

                screen.render();
            }

            _screen.render();
        });
    };
    // список диалогов
    //# слева



    /*

    // получение сообщений диалога
    'messages.getHistory', {
        access_token: TOKEN,
        v: 5.24,
        user_id: 56032614
    },


    // отправка сообщения пользователю
    'messages.send', {
        user_id: id,
        message: Text
    }
*/



    /**
         _                __                  _   _
        | |              / _|                | | (_)
      __| | ___  _ __   | |_ _   _ _ __   ___| |_ _  ___  _ __  ___
     / _` |/ _ \| '_ \  |  _| | | | '_ \ / __| __| |/ _ \| '_ \/ __|
    | (_| | (_) | |_) | | | | |_| | | | | (__| |_| | (_) | | | \__ \
     \__,_|\___/| .__/  |_|  \__,_|_| |_|\___|\__|_|\___/|_| |_|___/
                | |
                |_|
    */

    //  Отобразить сообщения как прочитанные. Передается массив с id сообщений
    var can_read = true;
    this.read = function(mid) {
        if (can_read) {

            if (mid.length > 0) {
                mid = mid.join(',');
                vk.request('messages.markAsRead', {
                    mids: mid
                });
            }

            can_read = false;
        }
    };

    //    Отображать дату в нужном формате
    this._date = function(date) {
        var d = new Date(date * 1000);
        return d.getHours() + ':' + d.getMinutes() + ' ' + d.getDate() + '.' + d.getMonth() + '.' + d.getFullYear();
    };

    // массив со списком друзей
    var uidFriends = {};
    var user_ids = [];

    var _friend = function(id) {

        if (uidFriends[id]) {
            return uidFriends[id];
        }

        user_ids.push(id);

        setTimeout(function() {

            if (user_ids.length === 0)
                return false;

            for (var i in user_ids) {
                user_ids[i] = parseInt(user_ids[i], 10);
            }

            vk.request('users.get', {
                user_ids: user_ids.join(','),
                fields: 'verified',
                name_case: 'Nom',
                v: 5.21
            });

            user_ids = [];

            vk.on('done:users.get', function(data) {
                if (data && data.response) {
                    for (var i = 0; i < data.response.length; i++) {
                        uidFriends[data.response[i].id] = data.response[i].first_name + ' ' + data.response[i].last_name;
                    }
                }
            });

        }, 1000);

        return id;
    };


    return this;
};